<template>
    <div id="sgv-report-view" class="st-view">
        <STNavigationBar title="Synchronisatie-rapport" :dismiss="canDismiss" :pop="canPop" />

        <main>
            <h1>
                Synchronisatie-rapport
            </h1>

            <div v-if="report.errors.length === 0" class="info-box">
                Kijk zelf ook nog snel eens alles na in de groepsadministratie als het de eerste keer is dat je synchroniseert.
            </div>
            <div v-else class="error-box">
                De synchronisatie is niet volledig gelukt. Kijk de foutmeldingen hieronder na en los ze op. Synchroniseer daarna opnieuw.
            </div>

            <div v-for="(error, index) in report.errors" :key="index" class="error-box-parent">
                <div class="error-box" :class="{ selectable: canClickError(error)}" @click="handleError(error)">
                    <h2 v-if="error.member" class="style-title-list">
                        {{ error.member.firstName }} {{ error.member.lastName || error.member.details.lastName }}<span v-if="canClickError(error)" class="icon arrow-right-small" />
                    </h2>
                    {{ getErrorMessage(error) }}
                </div>
            </div>

            <div v-for="(warning, index) in report.warnings" :key="index" class="warning-box">
                {{ warning }}
            </div>

            <STList v-if="report.info.length">
                <STListItem v-for="(info, index) in report.info" :key="index">
                    {{ info }}
                </STListItem>
            </STList>

            <template v-if="report.unmanagedInStamhoofd.length > 0">
                <hr>
                <h2>Leiding in Stamhoofd</h2>
                <p>Hoera, deze leiding schreef ook in via Stamhoofd. Stamhoofd zet hun gegevens van Stamhoofd netjes over in de groepsadministratie, maar je moet zelf nog de juiste functies toekennen in de groepsadministratie (bv. wie is materiaalmeester, kapoenenleiding...). Kijk je dit na?</p>

                <STList>
                    <STListItem v-for="{member, lid} in report.unmanagedInStamhoofd" :key="member.id">
                        <div>
                            <h2 class="style-title-list">
                                {{ member.details.firstName }} {{ member.details.lastName }}
                            </h2>
                            <p v-if="member.details.birthDay" class="style-description-small">
                                {{ member.details.birthDay | date }}
                            </p>
                            <p class="style-description-small">
                                {{ getLidFuncties(lid) || 'Geen functies' }}
                            </p>
                        </div>
                    </STListItem>
                </STList>
            </template>

            <template v-if="report.deleted.length > 0">
                <hr>
                <h2>Geschrapt in de groepsadministratie</h2>
                <STList>
                    <STListItem v-for="member in report.deleted" :key="member.id">
                        <div>
                            <h2 class="style-title-list">
                                {{ member.firstName }} {{ member.lastName }}
                            </h2>
                            <p class="style-description-small">
                                {{ member.birthDay | date }}
                            </p>
                        </div>
                    </STListItem>
                </STList>
            </template>
        
            <template v-if="report.created.length > 0">
                <hr>
                <h2>Nieuwe leden toegevoegd in de groepsadministratie</h2>
                <STList>
                    <STListItem v-for="{member, lid} in report.created" :key="member.id">
                        <div>
                            <h2 class="style-title-list">
                                {{ member.details.firstName }} {{ member.details.lastName }}
                            </h2>
                            <p v-if="member.details.birthDay" class="style-description-small">
                                {{ member.details.birthDay | date }}
                            </p>
                            <p class="style-description-small">
                                {{ getLidFuncties(lid) || 'Geen functies' }}
                            </p>
                        </div>
                    </STListItem>
                </STList>
            </template>

            <template v-if="report.synced.length > 0">
                <hr>
                <h2>Aangepaste leden in de groepsadministratie</h2>
                <STList>
                    <STListItem v-for="{member, lid} in report.synced" :key="member.id">
                        <div>
                            <h2 class="style-title-list">
                                {{ member.details.firstName }} {{ member.details.lastName }}
                            </h2>
                            <p class="style-description-small">
                                {{ member.details.birthDay | date }}
                            </p>
                            <p class="style-description-small">
                                {{ getLidFuncties(lid) || 'Geen functies' }}
                            </p>
                        </div>
                    </STListItem>
                </STList>
            </template>

            <template v-if="report.unmanagedMissingInStamhoofd.length > 0">
                <hr>
                <h2>Leiding niet in Stamhoofd</h2>
                <p>Deze leiding staat in de groepsadministratie, maar niet in Stamhoofd. Hun gegevens worden niet aangepast door Stamhoofd. Kijk de gegevens én functies na in de groepsadministratie zelf (wie is materiaalmeester, kapoenenleiding...). Schrap ze uit de groepsadministratie indien nodig.</p>

                <STList>
                    <STListItem v-for="member in report.unmanagedMissingInStamhoofd" :key="member.id">
                        <div>
                            <h2 class="style-title-list">
                                {{ getLidName(member) }}
                            </h2>
                            <p class="style-description-small">
                                {{ getLidBirthDay(member) }}
                            </p>
                            <p class="style-description-small">
                                {{ getLidFuncties(member) || 'Geen functies' }}
                            </p>
                        </div>
                    </STListItem>
                </STList>
            </template>

            <template v-if="report.skipped.length > 0">
                <hr>
                <h2>Overgeslagen</h2>
                <p>Deze leden werden recent nog gesynchroniseerd en zijn sindsdien niet gewijzigd in Stamhoofd.</p>

                <STList>
                    <STListItem v-for="member in report.skipped" :key="member.id">
                        <div>
                            <h2 class="style-title-list">
                                {{ member.details.firstName }} {{ member.details.lastName }}
                            </h2>
                            <p v-if="member.details.birthDay" class="style-description-small">
                                {{ member.details.birthDay | date }}
                            </p>
                        </div>
                    </STListItem>
                </STList>
            </template>

            <template v-if="report.imported.length > 0">
                <hr>
                <h2>Geïmporteerd in Stamhoofd</h2>
                <STList>
                    <STListItem v-for="member in report.imported" :key="member.id">
                        <div>
                            <h2 class="style-title-list">
                                {{ member.details.firstName }} {{ member.details.lastName }}
                            </h2>
                            <p class="style-description-small">
                                {{ member.details.birthDay | date }}
                            </p>
                        </div>
                    </STListItem>
                </STList>
            </template>
        </main>

        <STToolbar>
            <template slot="right">
                <LoadingButton :loading="loading">
                    <button class="button primary" type="button" @click="goNext">
                        Sluiten
                    </button>
                </LoadingButton>
            </template>
        </STToolbar>
    </div>
</template>

<script lang="ts">
import { isSimpleError, isSimpleErrors } from "@simonbackx/simple-errors";
import { Request } from "@simonbackx/simple-networking";
import { ComponentWithProperties, NavigationMixin } from "@simonbackx/vue-app-navigation";
import { BackButton, Checkbox, LoadingButton, STErrorsDefault, STInputBox, STList, STListItem, STNavigationBar, STToolbar } from "@stamhoofd/components";
import { getLidBirthDay, getLidFuncties, getLidName, SGVMemberError, SGVSyncReport } from '@stamhoofd/structures';
import { Formatter } from '@stamhoofd/utility';
import { Component, Mixins, Prop } from "vue-property-decorator";

import MemberView from '../member/MemberView.vue';

@Component({
    components: {
        STNavigationBar,
        STToolbar,
        STInputBox,
        STList,
        STListItem,
        STErrorsDefault,
        Checkbox,
        BackButton,
        LoadingButton
    },
    filters: {
        date: Formatter.date.bind(Formatter)
    }
})
export default class SGVReportView extends Mixins(NavigationMixin) {
    loading = false

    @Prop({ required: true })
        report: SGVSyncReport

    goNext() {
        if (this.loading) {
            return;
        }

        this.dismiss({ force: true })
    }

    getLidFuncties(a) {
        return getLidFuncties(a);
    }

    getLidBirthDay(a) {
        return getLidBirthDay(a);
    }

    getLidName(a) {
        return getLidName(a);
    }

    getErrorMessage(error: Error) {

        if (error instanceof SGVMemberError) {
            return this.getErrorMessage(error.error)
        }
        
        if (Request.isNetworkError(error)) {
            return 'Er was een internetprobleem of de groepsadministratie was tijdelijk onbereikbaar, gaf een interne foutmelding of reageerde niet.'
        }
        if (!isSimpleError(error) && !isSimpleErrors(error)) {
            return error.message
        }
        if (error.hasCode('SGVError')) {
            return 'De groepsadministratie gaf volgende foutmelding terug: ' + error.getHuman()
        }
        return error.getHuman()
    }

    canClickError(error) {
        return (error.member && error.member.details)
    }

    handleError(error) {
        if (error.member && error.member.details) {
            this.present(new ComponentWithProperties(MemberView, { member: error.member }).setDisplayStyle("popup"))
        }
    } 
}
</script>